name: Deploy Odoo to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. SSH Setup (Equivalent to "Initialize SSH" step in Bitbucket)
      #    - We'll use a dedicated action for SSH key setup
      #    - AWS CLI setup might not be strictly needed just for SSH,
      #      but if you need to run AWS commands later, you can add it.
      # ----------------------------------------------------
      - name: Configure SSH Private Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }} # Use GitHub Secrets for your private key

      - name: Add EC2 Host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}

      # ----------------------------------------------------
      # 2. Connect to EC2 and Deploy (Equivalent to "Connect to EC2" step)
      #    - This step will run your deployment commands on the EC2 instance.
      #    - Replace `echo 'Connected!'` with your actual deployment script.
      #    - You'll likely want to `cd` into your project directory on EC2.
      #    - You'll probably want to `git pull` on the EC2, then `docker compose down && docker compose up -d --build`
      # ----------------------------------------------------
      - name: Deploy to EC2
        run: |
          PROJECT_PATH="/home/ubuntu/ae-odoo" 
          REPO_URL="https://github.com/mattedlopez88/odoo-law-firm.git"
          DOCKER_COMPOSE_CMD="docker compose" 
          
          echo "--- Starting EC2 Deployment Script ---"
          echo "Target Project Path on EC2: ${PROJECT_PATH}"
          
          ssh ubuntu@${{ secrets.EC2_HOST }} "bash -c '
            mkdir -p \"${PROJECT_PATH}\" || { echo \"Failed to create directory ${PROJECT_PATH}\"; exit 1; }
            cd \"${PROJECT_PATH}\" || { echo \"Failed to change directory to ${PROJECT_PATH}\"; exit 1; }
            
            if [ -d .git ]; then
              echo \"Git repository already exists, performing git pull...\"
              git pull origin main || { echo \"Failed to pull latest changes\"; exit 1; }
            else
              echo \"Git repository does not exist, performing git clone...\"
              git clone \"${REPO_URL}\" . || { echo \"Failed to clone repository\"; exit 1; }
            fi
            
            echo \"Checking for Docker Compose command: ${DOCKER_COMPOSE_CMD}\"
            if ! command -v \"${DOCKER_COMPOSE_CMD}\" &> /dev/null; then
                echo \"Error: ${DOCKER_COMPOSE_CMD} is not installed or not in PATH on EC2.\"
                echo \"Please install Docker Compose V2 (docker compose) or V1 (docker-compose) on your EC2 instance.\"
                exit 1
            fi

            echo \"Bringing down existing Docker containers...\"
            \"${DOCKER_COMPOSE_CMD}\" down || { echo \"Failed to bring down containers\"; exit 1; }
            
            echo \"Building and bringing up new Docker containers...\"
            \"${DOCKER_COMPOSE_CMD}\" up -d --build || { echo \"Failed to bring up containers\"; exit 1; }

            echo \"--- EC2 Docker Compose Script Finished ---\"
          '" || { echo "SSH connection or commands within EC2 failed!"; exit 1; }

          echo "--- Deployment Workflow Completed ---"
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}