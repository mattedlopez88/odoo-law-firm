name: Deploy Odoo to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure SSH Private Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }} # Use GitHub Secrets for your private key

      - name: Add EC2 Host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}

      - name: Deploy to EC2
        run: |
          PROJECT_PATH="/home/ubuntu/ae-odoo" 
          REPO_URL="https://github.com/mattedlopez88/odoo-law-firm.git"
          
          echo "--- Starting EC2 Deployment Script ---"
          echo "Target Project Path on EC2: ${PROJECT_PATH}"
          
          ssh ubuntu@${{ secrets.EC2_HOST }} "bash -c '
            mkdir -p \"${PROJECT_PATH}\" || { echo \"Failed to create directory ${PROJECT_PATH}\"; exit 1; }
            cd \"${PROJECT_PATH}\" || { echo \"Failed to change directory to ${PROJECT_PATH}\"; exit 1; }
            
            if [ -d .git ]; then
              echo \"Git repository already exists, performing git pull...\"
              git pull origin main || { echo \"Failed to pull latest changes\"; exit 1; }
            else
              echo \"Git repository does not exist, performing git clone...\"
              git clone \"${REPO_URL}\" . || { echo \"Failed to clone repository\"; exit 1; }
            fi

            docker compose down
            
            echo \"Building and bringing up new Docker containers...\"
            docker compose up -d --build || { echo \"Failed to bring up containers\"; exit 1; }

            echo \"--- EC2 Docker Compose Script Finished ---\"
          '" || { echo "SSH connection or commands within EC2 failed!"; exit 1; }

          echo "--- Deployment Workflow Completed ---"
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}